#[macro_use]
extern crate serde_derive;
#[macro_use]
extern crate async_trait;
#[macro_use]
extern crate tracing;
#[macro_use]
extern crate lazy_static;

use std::fmt;
use std::num::TryFromIntError;
use std::string::FromUtf8Error;

use config::ConfigError;
use tokio::time::error::Elapsed;

pub mod peers;

// pub mod listener;
// pub mod peer_connection;

pub mod frame;
pub mod message_common;
/// Contains all the soulseek protocol server message, see [`ServerRequest`] and [`ServerResponse`]
/// for a detailed explanation of each one.
///
///  [`ServerRequest`]: crate::server::messages::request::ServerRequest
///  [`ServerResponse`]: crate::server::messages::request::ServerResponse
pub mod server;

pub mod database;
pub mod settings;

pub type Result<T> = std::result::Result<T, SlskError>;
pub type Error = Box<dyn std::error::Error + Send + Sync>;

#[derive(Debug)]
pub enum SlskError {
    /// Not enough data is available to parse a message
    Incomplete,
    /// Timeout waiting for an answer`
    TimeOut(Elapsed),
    BackoffReached(u64),
    /// Peer disconnected
    ConnectionResetByPeer,
    /// Configuration error
    ConfigError(ConfigError),
    NoPermitAvailable,
    NoTicket,
    UnkownMessage,

    /// Invalid message encoding
    Other(crate::Error),
}

impl From<String> for SlskError {
    fn from(src: String) -> SlskError {
        SlskError::Other(src.into())
    }
}

impl From<&str> for SlskError {
    fn from(src: &str) -> SlskError {
        src.to_string().into()
    }
}

impl From<FromUtf8Error> for SlskError {
    fn from(_src: FromUtf8Error) -> SlskError {
        "protocol error; invalid frame format".into()
    }
}

impl From<TryFromIntError> for SlskError {
    fn from(_src: TryFromIntError) -> SlskError {
        "protocol error; invalid frame format".into()
    }
}

impl From<std::io::Error> for SlskError {
    fn from(src: std::io::Error) -> SlskError {
        SlskError::Other(Box::new(src))
    }
}

impl std::error::Error for SlskError {}

impl fmt::Display for SlskError {
    fn fmt(&self, fmt: &mut fmt::Formatter) -> fmt::Result {
        match self {
            SlskError::Incomplete => "stream ended early".fmt(fmt),
            SlskError::Other(err) => err.fmt(fmt),
            SlskError::TimeOut(elapsed) => {
                write!(fmt, "timed out after {} reading soulseek stream", elapsed)
            }
            SlskError::ConnectionResetByPeer => {
                write!(fmt, "Connection reset by peer")
            }
            SlskError::ConfigError(err) => {
                write!(fmt, "Configuration error : {}", err)
            }
            SlskError::BackoffReached(value) => {
                write!(fmt, "Backoff period reached : {}", value)
            }
            SlskError::NoPermitAvailable => {
                write!(fmt, "No available connection")
            }
            SlskError::UnkownMessage => {
                write!(fmt, "Got unkown message")
            }
            SlskError::NoTicket => {
                write!(fmt, "Ticket for download not found")
            }
        }
    }
}

#[cfg(test)]
mod test {
    #[test]
    fn test() {
        // "in out"
        let data = hex::decode("050000000065000000").unwrap();
        println!("{:?}", data);
        // out in
        let data = hex::decode("000000000000000000000000").unwrap();
        println!("{:?}", data);
        // in out
        let data = hex::decode("64000000").unwrap();
        println!("{:?}", data);
        let data = hex::decode("000000000000000000000000").unwrap();
        println!("{:?}", data);

        // OK until here
        let data = hex::decode("4944330300000000010a545045320000000d00000047726176697465205a65726f544954320000001b00000033383031202852656d6978204a616d65732044656c6c65636b29545045310000000d00000047726176697465205a65726f54414c4200000004000000524d5854594552000000050000003230303554434f4e000000040000005261705452434b0000000200000038fffbe0640000000000000000000000000000000000000000000000000000000000000000496e666f0000000f00002504009719a1000205070a0c0f121417191c1f212426292c2e313336393b3e404245474a4c4f525457595c5f616466696c6e717376797b7e808285878a8c8f929497999c9fa1a4a6a9acaeb1b3b6b9bbbec0c2c5c7cacccfd2d4d7d9dcdfe1e4e6e9eceef1f3f6f8fbfe000000394c414d45332e39397201cd000000000000000034ff2405284d000140009719a1eae19978000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000fffbe064000248e8843ac32f65f07a0a44c20c29e2318e0ee815bc0001e835e056863001002440013e9a4752e598e789270216ed71c1cbb233411061919a3761ae34f923b92cc5c371ddb71e665f1c6b0d72661facec2a7216abb3c5d9d70a90d5ecfb60431d2bdb84dc5cccb6a50326a1b3bc4e383f91e1f84e10867c37a8ee7f973678ed85b0d04310c504d7913e879cea34f93b42f7019ec7e1383a2ad45b0e834d0b85153ea343d471e557c6521a0a0604314087a1ea37eced886385d765bceb9e02710c8aaf74af4f8938878f5a3d81bc9c2314e87b3cf4c3028edadc125658d48a05424223b8cbe00e82943c1cc9e7f06e0ac2b4e84a1f5876f181e198e604cb6c38c1844864ffa1c182225abf2a130e040038222d3f480d0b054068a4cde5962a089a5c120c1693d2aa100e55ac60241f281d81f2f002164472f160e22f00069fffffb2b28a1858e30e20c8c8c719d2c53223ffcc88d1e299199193298c38e30e834d368603ffd3f23126e73ddb09e6e66e6e6e4ebfd85ca3b084e09accb4e79f308c80e91128b8e183ee7b2d193e382c3e2415942a89cdb7007058c987b7bb9a162664d1a34ff9904c54386cc827f346cc993264d038163229739a4e31e4d102180a48c64d4c806c4a885930bfc60818600096ca09804488f405023060c2871010992289008cc41085a3a85048ce2302333ae80f2de8b09710144061afa574c9414f2e8b6e6b1b442dbab733056e604cd9554b3e67305c6f9a8129b365700682092ca5e52f5284c10974dd12f95fa7c4612bd5559446068acf139cb2ead885ebb201779400388d1d0bd4d60840c4404a96403845f68e4507808b8cada5b74061209f77e5fd41e644c45a3ae642851a8e20ca1bb2e66c89ed3c0402e7a4626152a973c49185c2310988ad40505b3b6c8652d5624b72f3ce93655028a8b057d3dc3a4083a8283a08d25bd7dcbae99ed3e4c0a1af88d5c58891e8e20d70c01c45fe95eaf58ac368bece1349568e95d5425b4a61e212a112005732883724a74b4751304b8c0623d30cb0f6e0826484537101222cd109a95d07459e25b823081811f8018b7244c098cb6a96aac0b104ae3404476be5e15f6904c716d3180a9dc856e193a7d1675bc1a8a152ce0a141a65e2ba975282ceaac70014e588148d096b88ba876775301009d71668009111133f44dddddfd10bf772ffd10bfff4244880095dc20000213bbc77d11377ffebbefa226eee4ee711109ddf40010880606062cd00000910abbe848004efa44033080088104122000008a68875ddf7774444fd11dddcf444777ffd0f442ff444444104188df1cfff007661ff1cfe8ff1ffe1ea2c0030048a040321008432100888359919520098107398bcc11bc65d2b852c3354913a628433942e38061a2500d1cce647b0d361c8c524e8c0525235029926318e16863c9a26ad2a80205c30134973378863fffbe264290009a566486e77a000dccc195dce6c0023559f335dce000b7aafa7bfb790013a0ca32507c34df7131d9c539002b0801c1417aa48f9908271a4a329890391894051ab4ab19aec518da108342681db343f13a50b03c61503c0a0801411a7a0700c99090ec08a00fb98619e7a75122d83d46b6ceeba3eaa262b0e900058d26fb9eadb074d482dc75712cd32b962e668d158e249e39ef9ce635fb6e188a4310e66fbb5f8bc897b3d2a65c75dca4aa4f2df7f7bef35cc3b498e71b8bdf676b0ec1dcc7fe44d2e0a48b8540ebba19bef22fae61f7f2ffe7efbcfd65177c9cb9f9458ce596396e512c9fc180ae57d9c6876ae345770ceddbd5ebffff102adff1ee0c9c72745228180206028180a0602810080449e15fe22010508061d1f297af730901884466af1d1b1362ca2f1984e66550c996186220edeb667c4c4428064f340898c598916fc022263e3665060024203443f0da437d050f9a00d2fdac6f74268ab602801e249fb5fcb0cde51391b97c695f586991afd7f73cf52fde72cc21a6fa5b629659571bd7fb8dbc33cffbf9f633434f2489ce6f5863dc75f94b39ffbeffea432aa5a6c2594d4bdef77bfefeff5db79e7861cd61f5edd359b13f28dcbe9e92bd27ef5acf59fff7986bf3efffffffeff3eff7ff96764964405fffecfffb558860000126d4e400c19349862406c31819743c6102e18902c6ec23187caa6443318e5306d44e86018cfe243478182a000b97cc7a290609c40690c2118746062d3f0543418b2308c08c6e760c5087154c7e11322130cce39319098a032247430b928c7e1f051e01c092d60f02923e699b3237d1662e4671311277232f7cae0060ed51a73f8fa5040118bcfd4925aef353bf4d0748633a97c46138472470ec7770ece35f9b825f4b72b895596ccf2532d8f5ab14d3976250ec92b52537c3f25a7e5995e77ed4624d5e86590ecb6ce3729fb5657410d4f5c9cb91c88c8a5717a2a793bb95ddb7e9e1a793ba1108764f8cddd8c50599255af8c190fd7826a45ea5359b1cbd3f4f139ea490435529e5f4f438ca7949baf4b95cc2edc0494100620000016bac9c784423ecd6a7806042464182e004131309222031b2f37c47353fe3021b31e0b0213028a9b894010a0a80771470715192f0e64cf100bc62c5992380322404c63539563a3b9981c34bfa06a58440b849ebca6b5c8f56b94f2b9da9137d5f971592bfd8c37238d5d7466a6640f847be35435e0097c0d2ca583206742dd4a91c9554d3b9350ecbed724b2dce6e9f58dfa7ddfa79ca0af9e587d7cf3af77b5f9963fab952ff2f5aca9b59d276afe1417f3fa3c356aeea5967f7773de7fae6b0d730cf2ced5baf4986b3b7dcb99ebbfbc6bf7284366cbef2580000000000924aa281d3318d4cbbf62b2b0a1c4c5a8d30a0d474106383b05d4062302995d066dc549c143265f141c55e19d5a8ba1884b0cfffbe2441c0467e962cbeb9b7b52e5cc09776decc25ef5832cce693583f3346549de3178c10414705805320540c4832f4614920f2c3310c3077c30c53330163ef243731c33c5537c0c072c1a58c809419898b81b4716086b6a0ca649e328fe559e0878b1ed3aa48cf0f54d9baa0bab71deabd99998db23c3f0d52b8bb536662458b05f39bd7b1a03a7086b70ab1b4db0d8898b642606d837dd965b5eda8e9fbb8b355f3e659f4cab854b74901e55a98193ad41542cbc5dc362bc76e8ec2864582b7161e9b1ce032b56995ce4ce2339a8154b4f203028646c747fb947dcf03c77de69752457527981eb100001208518c99594193e3202ca0b0cd42c41ec74568628f80dd83323830b49312ad07bd93811aa0c1990c32f18083459b3180844e31d1d122d0b0e9bd3d1ae191b00281620cbf9ceb860e3568c0980ef138dc94c38a83a3cd04209454403f1759b022bf5a8ac20ca4521ee4f0ff7a72b29673418a8d78f5961ee2a7df6dcb89662808ce09086af8fb9240b54adba57df754aaf7b58b9f1fae0b5534b0e397d8d132d393849e6a578e26d8de7a8faeab175fedf28a52f7b1ef1897cbd8ca13c88c113a66dabca1fb4e1c1e452d3aaab1b8747c78c2caeac62fdefca465d7d4640915ca21bd10002a3b8663c1d99569074e070206e60a50997dba6b3c21bce166632701876224619519c745389a485e6bba999e18263b0a1698c20223260181803305890ca40f1e0799cd2e6840a18646860945988828550d1debc67a01d82067ce9b91e162e62c618f246054c3e3a0e5c986ff38f4e9c8cb2573ca5d2d8b4a9ff81df4872acf50ea76e4a6b45338d56964d72829a7e04b794ba9e5b730e4fc6e7e929e66df6a49a5f494f4f4b1668f1acb72b806a631e998a4aa8f5d876d451bf7607e8361b1fa611b42a6563e8da7cd015241f269a6282c60ba113e2aa449f4e09e5bb02cc2ed1d9a1889d85880f2e5a6b33046c5356c4cb50b4a8c1200d554c520ccc1b5c8c54008c2b24c6147184a0e77214d0e414c58350c180e8c23130e04d436f9dce7c06327288c60a3367028c3a5a3252bc1cf430404cc243232307cc284e382b1cd580d3628bcc6e3a3190e8d30cb077f0c84a501574c8a0130f94cb8624f63048592ed340b3687176d11de27f9fa6711b7f18fd04be3c471cc2a162a383b531098d980903a797ccd49ea01e81f790bc42b244513d8d9f298c96f1e968f5c38e2515c0903ea8b5ca3623a3e43ab478db072f2bb4676f520a01f33566ba9a3423db97bf513e90d1cfb15fd6223464d17ff5db3f6ea8ffd1d1ad86c952d984335814b91fcbcd57562e6987228eacd3ff60dcdc9e8f7a95000289514081a5932e9acd7c5130d854b05a32f9f4d0cd03d73b8ce6343219341891303d38dde24329804cbca132b94c318a6065262c846c0122c6e622b60689087131de3184300881900199b4d10bd1f8fffbe244288c67b567cb9b9b63f2f82c597a736c961fa1972c4e3cdb4be6b425cdcdb1f82108e18cd864084065a5a9882c745ab4382192620042501cbedf19d9c70a9169b37964b64b564d158dda9ecf196652c8e534961db71c7b6acf469392530c4af7729c0a1de7a0797a54adb4bd7219d2b69a03a72b57b47f7716b543bbd54fa43f81c3e396d6154c41c3888ee56ae8d31616888cbcb2288d1f38a0fab5b098111718e96d2c286a9b5d15b5ae6a6b8d2a585d30f5bcd275d75ace755abd1e6bed1cdef994bf32d400000002480a0541e0e8798367c06b41874326b4641b5db27dd3299257c6013a18b83466b479b4560669081a650a6bb8d826d66fe3218f02a281e31d0344408312894043d1009cc3f0f06231cb8f1990290781e2629de1f1a81019b0109be190141838225b0d06080855e97622ed7de26852b5e528e394813ce312d56f974373423bc743e13a0a18a62205a09042b9f1fc4834433794aacdbfff527c9daa39b3d91599b9d99a33cbb2eb6b2b05df97eff6b263c7f8b305900e97a1a1f3870dcd1bac715de2ae9e09cb87d3209570351fd3890516d06f8c6a978fda9e64baa890a5b337607974fc674c3ad2f7d0a39c6ec99e2af0780c6fa40450d0c8006531b684acfc64714022dc6fc289ed2c26d96f99e5386291d995d20491833e944cb29a315c48cfe7b32e060c9c6802a102200a6260e3f890a458c06564f998c426052f9a4c5068b2f19d9a47484398a50a18c532d09c547661c16008dc800303898202a24060480901cfb4813ddc64eb62ede1305a38ffd96852210851fa415894aca8b53a3e64f22632bdcb2f17258e55b37f0a56c9d5c9d618ebcfd6d4332962b3c699828e0539faad8adf0dcd6a155be691b9b999c5adcd6235e482c8a85d9dadc8b86a3677ce48d8ce0cefe59fddb359929986481a182ef9e5b7bbdfc78f6c6bd4e0e0b27e260e1e3672f6a0ed2dcb7b641f5a695da090a6065e08189cc86ea149824da6b5961ad0e2610240cb84c5e6e31f174c226631195c1c2835e168bc66e99f9a680c64a54610d063c1ae282214c4c2cd6c14df240cb6a83440ce45c28e070c486e742716b06f0666b4664a06d2c2000495515088815814c56a3ab4d02c332769e950b3a71ce82ddc8b3728b4e456dd589da9e92bb4fd43f17b3aa5b8e88901c010ab16ced3d8f8c5e64bc38b464b8b080ebec150ca80dcfcf8d19fdc30525d6fce2ef223938405d03e8470200bce58971b79b43223f58dd88efccdef4a99a7508c07081b74ba259944bb98571d187e695b221dcbcb0e579b4d143773e384a7e7676f6317a5d9a59bad31bf8aca800000004920c10080607e6a4b482a0462a0f9b4d1264f201cdb026c4b6180c660e379b00d4621900800668e01929f1b75e9b0061803798587872abf4096930b1524283222f036d19da39b00c187f29ac161f18e1932918813184939fffbe2442e04e7b0684bd39b6361038cf951778c6eded197306eed8fc40cb3e58dc7b330012010f0a0d49044c59243839a52fc4ca7d1d3735d87e9d694a3c4a6551ab028200c92b34e52bda1c5827192f61338c0920f0409248670662d270feae113cf3561d3ca52a78a26d695792b0bf93d594692a7cb185329ce1f52d46d1f24a962a94c1c3a5cd1e2a71deeb217ab588df324ef00b192ab6425479cdb5d17f64c1b2eacb9cab1255346c8acf6d6f97475b736c5a0ab76efcb655ec6eb004541431b43f307d7735681731d0cf3426e930f1a137e0b23039743094b608090c120c454790b8fc6760686ed731951926ce1598c4246225f038282a13021b4cd6153308e05574220a9ac03663b048cb50cf0e23333f8ddd5533f18c493e0e65986c80010e0800610151a361281db9afa9cb31c705455f661afd2c3b53bb146c2dde34cde725d5e333d22937d7cfcdd628130690a4e0e0620df4d4c1c1eaf597de80e90163298d4f0e6e00b09974084e189c412ada7109115caef1753d477565cc03603dd270e4a9f5c6e704f35e5474ac4b538d412ea6352a944c0904c630f8f572c428b7726962e2f34dabb913d8eb75e73fa25dd4bb55aaccfbf4ccdf22cde7defb0022483591128c26431823c9b1822198a42261d22c66a0786e3a3e62c0de6148826378846261a462904c63986e2c5398d09987190642f864496c297290bf99885980139ee97188a08e108aaa19a229960f9ad1f8983180b89a08d81100c0c1c0caa996140a11012582792081e97619edb7ba714e81423015b9ab4ff3f759f2933850ec4a82430fe33b2fcae44622edbd04a02ac18eb38d95a5db999f347c736d2f3a84b6ca122e2d981c2f53874ecc4a17410d7584af3cfb273deb8cd1ff59141cb2f2db5032ce9f1e31afbebd0c1a0123d75f74faeb1cad5da4f6ef9ea7d6524af7ce916c537ac0f4d9e4f683dfad2d45ccf815624eb0018a7cc6c2e310d44c0c2432e030ae48785941bd89062f9e99896c6540599a94067b6c98b5407f3571bdc447405399587a60c16986c546700a1311cc7c5e125f18e412707239825c266b1a98f02262c5419325c6538b99fd22162d98cc28650269838700222808b605050f0d1c1769642d4684f1de2b45f1fe3d64f1ca656b127926a492c85bf4f429d458738187cf142718405757beda17a563bc6a39b9a76cf1709aa41fb6554418afa165e34daead5884e9ad770a1c8e7bc36b43461faaccb96adcf24cc382edf4d9c275b5a5cf2a788a176f5b86f1e10da68c51bbf9a03a856b47be0aaa16363e0dda615ad3c3088f0bace627bf33cbdfaadfd716b2cdd8d0c74d500100011c40726cc805c35a86c743c78cf41f24c6763f41d73406ba40820306ea4a994e466345f82bd6639ba9beec2106934aa54c603d3130090fcc640e33d848c2e6538c4e8c0e5b02014c50a732d1d0c185739691cd802e3fffbe2442c844834674b1b8f66c109ed198a778f4e1fc1832f2eeded83ae31671dbd3da9122d4c7c5a322024c46183008bcc282c2e7190004443d6d61e7f2b4c24fb776b62301040cdcf86e5a5c954ae355509c5347827721a8d5738c580ac6d7598e21449667cd7132cf1185c258b7bc1bc1637373c6de53086bf878f7493eed90d46fd7a0d33b84c6da73b639c8238491853c9164512ced99a6662d4677c9062d1de1499444a2a01b768e99a1cd100f7177676c27114556a351771b38374fb7b9f5df306109335391747d77db8ee68eea800000009140d1102060684e61e96663e8f261f92464fdd469501064995665517860b80e62f151b58ca6826399adb26796d18e15e6c12f99c47660d1e18102a6a0070a038c029a150718a49a6a28f99c4ea6890d9654c2e5e314188f5225320948901a062e98b44424050518c046a4842602a095da78192a08ee539a11c45c17f0d70caa28a79a7eafe11d6f138789fa7e17f86b956423d136de08c260ff344c97b0d6e24d6be93eebf5c467bb853b325c9e0fc666155ae5fb8424f2a5616598fe7a9bc5b0c307da3b41e8a0d761ac6cc2a41c7c53d5f374ee6ba78ef2aa128a5a6a3b3e659a6716edcf4faea99577680c2e0bb67b4582ccdd46dbe562d35e3ccf67965f8926f2e771ef0000040e4209187423184c4511316627060655dbc65e2d86b2c30677a1e60c9e06390a464d88e32b4981652991c28985ef1bae89c7039c81f1960e9a400a0e183411a7861ab9619a8b3151e4c00969b19f1917b982541bec51940c05174223c8500c6c14ca01cc0470c883523583b2590c38ca1a3c3cfb434060aa7a28a9612e9096a1bcac43f9fa5585fe690631c72c26f60311aa32d2b52f56dbcaa2504084e9fa75996996ecef204702da73ef0fe5c665f161d2adefd9b31372f522acdb48d1da96b1eec0c4cf453bd82cf96552bc4b4a9f78a53c988f271d476b80f77584f6f1ad8dc2baa2f11661bd8ae31a791b33bc5b72de0d02c510f5c5833a5100023714cec1908505c3cd7cb8c9060fb6fcb886ee8a6caae22160e2a3556a3311530b0c3a420358d0d69b0d8e60258c071f62d282ec88a09b120217851ec997824d22d188ce7ced028e88c283a9825f1af1a0e6ec015598f449a733594c4").unwrap();
        println!("{:?}", data);


        assert!(false);
    }
}
